---
import MainLayout from '../layouts/MainLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { getHomepageData, getAllPosts } from '../lib/data';
import { format, formatDistanceToNow, differenceInHours } from 'date-fns';
import { id } from 'date-fns/locale';
import { Image } from 'astro:assets';

const { 
  featured: featuredPost, 
  latest: latestPosts, 
  popular: popularPosts, 
  sorotan: sorotanPosts, 
  beritaTerkini,
  ragam: ragamPosts,
  pemkabKotim: pemkabKotimPosts,
  palangkaraya: palangkarayaPosts,
  politik: politikPosts
} = await getHomepageData();
const posts = latestPosts; // Using latestPosts as 'posts' fallback if needed
---

<MainLayout 
  title="NewsPortal - Berita Terkini" 
  preloadImage={featuredPost.image}
>
  <Header />
  
  <main class="pt-32 pb-12 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      
      <!-- Main Content Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- Left Column (Hero + Grid) -->
        <div class="lg:col-span-8">
          
          <!-- Hero Section -->
          <div class="relative rounded-lg overflow-hidden shadow-lg group cursor-pointer h-[400px] mb-8">
            <a href={`/${featuredPost.slug}`}>
              <Image 
                src={featuredPost.image} 
                alt={featuredPost.title} 
                width={1200}
                height={600}
                widths={[400, 800, 1200]}
                sizes="(max-width: 800px) 100vw, 800px"
                fetchpriority="high"
                loading="eager"
                class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
              />
              <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-90"></div>
              <div class="absolute bottom-0 left-0 p-6 w-full">
                <span class="inline-block px-3 py-1 bg-white text-blue-900 text-xs font-bold rounded-full mb-3 uppercase tracking-wider">
                  Headline
                </span>
                <h1 class="text-2xl md:text-3xl lg:text-4xl font-extrabold text-white leading-tight font-serif" set:html={featuredPost.title}>
                </h1>
              </div>
            </a>
          </div>

          <!-- Sub-Hero Grid (6 items) -->
          <div class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4">
            {latestPosts.map((post) => (
              <div class="group flex flex-col h-full bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                <a href={`/${post.slug}`} class="relative h-24 md:h-32 overflow-hidden block">
                  <Image src={post.image} alt={post.title} width={400} height={300} class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"/>
                </a>
                <div class="p-3 md:p-4 flex flex-col flex-1">
                  <a href={`/${post.slug}`}>
                    <h3 class="text-xs md:text-sm font-bold text-gray-900 leading-snug line-clamp-3 group-hover:text-blue-600 transition-colors" set:html={post.title}>
                    </h3>
                  </a>
                  <a href={`/category/${post.categorySlug}`} class="mt-auto pt-2 text-[10px] md:text-xs font-semibold text-orange-500 uppercase hover:text-blue-600 transition-colors">
                    {post.category}
                  </a>
                </div>
              </div>
            ))}
          </div>

          <!-- Sorotan Section -->
          <div class="bg-gray-900 rounded-lg p-6 mb-8 mt-8">
            <div class="flex items-center mb-6">
              <div class="w-1 h-6 bg-orange-500 mr-3"></div>
              <h2 class="text-xl font-bold text-white uppercase tracking-wide">Sorotan</h2>
            </div>
            
            <!-- Mobile: Vertical List -->
            <div class="md:hidden space-y-4">
              {sorotanPosts.map((post) => (
                <article class="group">
                  <a href={`/${post.slug}`} class="flex gap-3 items-start">
                    <div class="flex-1">
                      <h3 class="text-sm font-bold text-white leading-snug line-clamp-3 group-hover:text-blue-400 transition-colors mb-2" set:html={post.title}>
                      </h3>
                      <p class="text-xs text-gray-400">{format(new Date(post.date), 'd MMMM yyyy', { locale: id })}</p>
                    </div>
                    <div class="relative w-24 h-20 rounded-md overflow-hidden flex-shrink-0">
                      <Image 
                        src={post.image} 
                        alt={post.title} 
                        width={400}
                        height={300}
                        class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                      />
                    </div>
                  </a>
                </article>
              ))}
            </div>

            <!-- Desktop: Grid -->
            <div class="hidden md:grid grid-cols-3 gap-6">
              {sorotanPosts.map((post) => (
                <article class="group">
                  <a href={`/${post.slug}`}>
                    <div class="relative h-32 rounded-md overflow-hidden mb-3">
                      <Image 
                        src={post.image} 
                        alt={post.title} 
                        width={400}
                        height={300}
                        class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                      />
                    </div>
                    <h3 class="text-sm font-bold text-white leading-snug line-clamp-3 group-hover:text-blue-400 transition-colors mb-1" set:html={post.title}>
                    </h3>
                  </a>
                  <a href={`/category/${post.categorySlug}`} class="text-xs font-medium text-blue-400 hover:text-white transition-colors">
                    {post.category}
                  </a>
                </article>
              ))}
            </div>
          </div>

          <!-- Berita Terkini Section -->
          <div>
            <div class="flex items-center mb-6">
              <div class="w-1 h-6 bg-blue-600 mr-3"></div>
              <h2 class="text-xl font-bold text-gray-900 uppercase tracking-wide">Berita Terkini</h2>
            </div>
            
            <div class="space-y-6" id="berita-terkini-container">
              {beritaTerkini.map((post, index) => {
                const postDate = new Date(post.date);
                const isRecent = differenceInHours(new Date(), postDate) < 24;
                const displayDate = isRecent 
                  ? formatDistanceToNow(postDate, { addSuffix: true, locale: id }).replace('sekitar ', '')
                  : format(postDate, 'd MMMM yyyy', { locale: id });

                return (
                 <article class={`flex flex-col sm:flex-row gap-4 group border-b border-gray-100 pb-6 last:border-0 hover:bg-gray-50 transition-colors p-2 rounded-lg ${index >= 5 ? 'hidden' : ''} berita-item`}>
                    <a href={`/${post.slug}`} class="flex-shrink-0 w-full sm:w-48 h-32 relative overflow-hidden rounded-lg">
                      <Image 
                        src={post.image} 
                        alt={post.title} 
                        width={400}
                        height={300}
                        class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                      />
                    </a>
                    <div class="flex flex-col justify-center">
                      <a href={`/${post.slug}`}>
                        <h3 class="text-lg font-bold text-gray-900 leading-snug hover:text-blue-600 transition-colors mb-2" set:html={post.title}>
                        </h3>
                      </a>
                      <div class="flex items-center text-xs text-gray-500 mb-2">
                        <span class="text-blue-600 font-semibold uppercase">{post.category}</span>
                        <span class="mx-2">â€¢</span>
                        <time datetime={post.date}>{displayDate}</time>
                      </div>
                    </div>
                  </article>
                );
              })}
            </div>
            
            {beritaTerkini.length > 5 && (
              <div class="mt-8 text-center">
                  <button id="load-more-btn" class="px-6 py-2 border border-gray-300 rounded-full text-sm font-semibold text-gray-600 hover:bg-gray-100 transition-colors">
                    Muat Lebih Banyak
                  </button>
              </div>
            )}
          </div>

          <!-- Category Grid Section -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-12 pb-8">
            
            <!-- Ragam Dan Peristiwa -->
            <div>
              <div class="flex items-center mb-4">
                <div class="w-1 h-5 bg-red-600 mr-2"></div>
                <h3 class="text-lg font-bold text-gray-900 uppercase">Ragam Dan Peristiwa</h3>
              </div>
              <div class="space-y-4">
                {ragamPosts.map(post => (
                  <a href={`/${post.slug}`} class="flex gap-4 group">
                    <div class="w-24 h-16 flex-shrink-0 rounded overflow-hidden">
                      <Image src={post.image} alt={post.title} width={200} height={150} class="w-full h-full object-cover group-hover:scale-105 transition-transform"/>
                    </div>
                    <div class="flex-1">
                      <h4 class="text-sm font-bold text-gray-900 leading-tight group-hover:text-red-600 transition-colors line-clamp-2">{post.title}</h4>
                      <time class="text-xs text-gray-500 mt-1 block">{format(new Date(post.date), 'd MMM', { locale: id })}</time>
                    </div>
                  </a>
                ))}
              </div>
            </div>

            <!-- Pemkab Kotim -->
            <div>
              <div class="flex items-center mb-4">
                <div class="w-1 h-5 bg-blue-500 mr-2"></div>
                <h3 class="text-lg font-bold text-gray-900 uppercase">Pemkab Kotim</h3>
              </div>
              <div class="space-y-4">
                {pemkabKotimPosts.map(post => (
                  <a href={`/${post.slug}`} class="flex gap-4 group">
                    <div class="w-24 h-16 flex-shrink-0 rounded overflow-hidden">
                      <Image src={post.image} alt={post.title} width={200} height={150} class="w-full h-full object-cover group-hover:scale-105 transition-transform"/>
                    </div>
                    <div class="flex-1">
                      <h4 class="text-sm font-bold text-gray-900 leading-tight group-hover:text-blue-500 transition-colors line-clamp-2">{post.title}</h4>
                      <time class="text-xs text-gray-500 mt-1 block">{format(new Date(post.date), 'd MMM', { locale: id })}</time>
                    </div>
                  </a>
                ))}
              </div>
            </div>

            <!-- Palangka Raya -->
            <div>
              <div class="flex items-center mb-4">
                <div class="w-1 h-5 bg-green-600 mr-2"></div>
                <h3 class="text-lg font-bold text-gray-900 uppercase">Palangka Raya</h3>
              </div>
              <div class="space-y-4">
                {palangkarayaPosts.map(post => (
                  <a href={`/${post.slug}`} class="flex gap-4 group">
                    <div class="w-24 h-16 flex-shrink-0 rounded overflow-hidden">
                      <Image src={post.image} alt={post.title} width={200} height={150} class="w-full h-full object-cover group-hover:scale-105 transition-transform"/>
                    </div>
                    <div class="flex-1">
                      <h4 class="text-sm font-bold text-gray-900 leading-tight group-hover:text-green-600 transition-colors line-clamp-2">{post.title}</h4>
                      <time class="text-xs text-gray-500 mt-1 block">{format(new Date(post.date), 'd MMM', { locale: id })}</time>
                    </div>
                  </a>
                ))}
              </div>
            </div>

            <!-- Politik -->
            <div>
              <div class="flex items-center mb-4">
                <div class="w-1 h-5 bg-purple-600 mr-2"></div>
                <h3 class="text-lg font-bold text-gray-900 uppercase">Politik</h3>
              </div>
              <div class="space-y-4">
                {politikPosts.map(post => (
                  <a href={`/${post.slug}`} class="flex gap-4 group">
                    <div class="w-24 h-16 flex-shrink-0 rounded overflow-hidden">
                      <Image src={post.image} alt={post.title} width={200} height={150} class="w-full h-full object-cover group-hover:scale-105 transition-transform"/>
                    </div>
                    <div class="flex-1">
                      <h4 class="text-sm font-bold text-gray-900 leading-tight group-hover:text-purple-600 transition-colors line-clamp-2">{post.title}</h4>
                      <time class="text-xs text-gray-500 mt-1 block">{format(new Date(post.date), 'd MMM', { locale: id })}</time>
                    </div>
                  </a>
                ))}
              </div>
            </div>

          </div>

          <script>
            const loadMoreBtn = document.getElementById('load-more-btn');
            const hiddenItems = document.querySelectorAll('.berita-item.hidden');

            if (loadMoreBtn && hiddenItems.length > 0) {
              loadMoreBtn.addEventListener('click', () => {
                // Show all hidden items
                hiddenItems.forEach(item => {
                  item.classList.remove('hidden');
                });
                
                // Hide the button after loading
                loadMoreBtn.classList.add('hidden');
              });
            }
          </script>

        </div>

        <!-- Right Column (Popular) -->
        <div class="lg:col-span-4">
          <div class="sticky top-24">
            <div class="flex items-center mb-6">
              <div class="w-1 h-6 bg-orange-500 mr-3"></div>
              <h2 class="text-xl font-bold text-gray-900 uppercase tracking-wide">Terpopuler</h2>
            </div>
            
            <div class="space-y-6">
              {popularPosts.map((post, index) => (
                <article class="flex items-start group">
                  <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-500 font-bold text-lg mr-4 group-hover:bg-orange-500 group-hover:text-white transition-colors">
                    {index + 1}
                  </div>
                  <div class="flex-1">
                    <a href={`/${post.slug}`}>
                      <h3 class="text-base font-bold text-gray-900 leading-snug group-hover:text-blue-600 transition-colors mb-1" set:html={post.title}>
                      </h3>
                    </a>
                    <a href={`/category/${post.categorySlug}`} class="text-xs text-orange-500 font-medium uppercase hover:text-blue-600 transition-colors">
                      {post.category}
                    </a>
                  </div>
                </article>
              ))}
            </div>

            <div class="mt-12">
              <a href="#" class="text-blue-600 hover:text-blue-800 text-sm font-semibold flex items-center group">
                Terpopuler Lainnya 
                <svg class="w-4 h-4 ml-1 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
              </a>
            </div>

            <!-- Ad Placeholders -->
            <div class="mt-8 space-y-4">
              <div class="bg-gray-200 rounded-lg flex items-center justify-center text-gray-400 font-bold h-64 text-sm uppercase tracking-wider">
                Iklan 1
              </div>
              <div class="bg-gray-200 rounded-lg flex items-center justify-center text-gray-400 font-bold h-64 text-sm uppercase tracking-wider">
                Iklan 2
              </div>
              <div class="bg-gray-200 rounded-lg flex items-center justify-center text-gray-400 font-bold h-64 text-sm uppercase tracking-wider">
                Iklan 3
              </div>
            </div>
          </div>
        </div>

      </div>

    </div>
  </main>

  <Footer />
</MainLayout>
